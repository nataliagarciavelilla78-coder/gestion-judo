<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión Judo – Colegios y Profesores (MVP local)</title>
<style>
  :root{
    --bg:#0f172a;
    --card:#111827;
    --muted:#6b7280;
    --text:#e5e7eb;
    --accent:#22c55e;
    --accent-2:#3b82f6;
    --danger:#ef4444;
    --warn:#f59e0b;
    --ok:#10b981;
    --border:#1f2937;
  }
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body{
    margin:0;
    background:linear-gradient(180deg, #0b1024, #0a132f 40%, #0b0f1c 100%);
    color:var(--text);
    font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  header{
    position: sticky; top:0; z-index:2;
    background: rgba(15,23,42,.9);
    backdrop-filter: blur(6px);
    border-bottom:1px solid var(--border);
  }
  .wrap { max-width:1100px; margin:0 auto; padding: 16px; }
  h1{ font-size:20px; margin:0; display:flex; align-items:center; gap:10px; }
  .badge{ padding:2px 8px; border-radius:999px; background:var(--accent-2); color:white; font-size:12px; }
  nav{ display:flex; gap:8px; flex-wrap: wrap; margin-top:10px; }
  nav button{
    appearance:none; border:1px solid var(--border); background:#0b1224; color:var(--text);
    padding:8px 10px; border-radius:8px; cursor:pointer;
  }
  nav button.active{ border-color: var(--accent-2); background: rgba(59,130,246,.15); }
  main{ padding: 16px; }
  .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); }
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border:1px solid var(--border);
    border-radius:12px; padding:14px;
  }
  .card h3{ margin:0 0 8px 0; font-size:16px; }
  label{ display:block; margin:8px 0 4px; color:#cbd5e1; }
  input, select, textarea{
    width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);
    background:#0a1222; color:var(--text);
  }
  textarea{ min-height:66px; }
  .row{ display:flex; gap:8px; }
  .row > *{ flex:1; }
  .actions{ display:flex; gap:8px; flex-wrap: wrap; }
  .btn{
    appearance:none; border:1px solid var(--border); background:#0b1224; color:var(--text);
    padding:8px 10px; border-radius:8px; cursor:pointer;
  }
  .btn.primary{ background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color:#1d4ed8; color:white; }
  .btn.success{ background: linear-gradient(180deg, #16a34a, #15803d); border-color:#15803d; color:white; }
  .btn.warn{ background: linear-gradient(180deg, #f59e0b, #b45309); border-color:#b45309; color:white; }
  .btn.danger{ background: linear-gradient(180deg, #ef4444, #b91c1c); border-color:#b91c1c; color:white; }
  table{ width:100%; border-collapse: collapse; }
  th, td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align: top; }
  th{ font-weight:600; color:#cbd5e1; }
  tr:hover td{ background: rgba(255,255,255,.02); }
  .tag{ display:inline-flex; gap:6px; align-items:center; padding:2px 8px; background:#0b1224; border:1px solid var(--border); border-radius:999px; font-size:12px; }
  .pill{ padding:2px 6px; border-radius:6px; font-size:12px; color:white; }
  .pill.ok{ background: var(--ok); }
  .pill.warn{ background: var(--warn); color:black; }
  .pill.danger{ background: var(--danger); }
  .muted{ color:var(--muted); }
  .kbd{ font:12px/1.1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1224; border:1px solid var(--border); padding:2px 6px; border-radius:6px;}
  .footer{ text-align:center; color:var(--muted); padding:30px 10px; }
  details{ border:1px dashed var(--border); border-radius:8px; padding:8px 10px; }
  summary{ cursor:pointer; font-weight:600; }
  .no-data{ color:#9ca3af; text-align:center; padding:16px; }
  .inline{ display:inline-flex; gap:6px; align-items:center; }
  .right{ text-align:right; }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Gestión Judo <span class="badge">MVP local</span></h1>
    <nav id="tabs"></nav>
  </div>
</header>

<main class="wrap">
  <section id="view"></section>
</main>

<footer class="footer">
  Datos guardados en <span class="kbd">localStorage</span>. Exporta antes de limpiar el navegador.
</footer>

<script>
/* =======================================================
   MVP 100% local (sin backend). Doble clic para abrir.
   Entidades: profesores, colegios, grupos, sesiones, asistencia, incidencias, mensajes, pagos.
   ======================================================= */

const App = {
  state: {
    profesores: [],
    colegios: [],
    grupos: [],
    sesiones: [], // {id, grupo_id, fecha_inicio, fecha_fin, profesor_id, sustituto_id, estado}
    incidencias: [],
    mensajes: [],
    pagos: [], // {id, profesor_id, periodo, horas, importe, detalle}
    alumnos: [], // opcional por grupo
    meta: { lastId: 1 }
  },
  tabs: [
    ["inicio", "Inicio"],
    ["profesores", "Profesores"],
    ["colegios", "Colegios"],
    ["grupos", "Grupos"],
    ["calendario", "Calendario"],
    ["sesiones", "Sesiones"],
    ["incidencias", "Incidencias"],
    ["mensajes", "Mensajes"],
    ["pagos", "Horas y Pagos"],
    ["datos", "Importar/Exportar"]
  ],
  init(){
    this.load();
    this.router();
    window.addEventListener("hashchange", ()=>this.router());
  },
  nextId(){ return this.state.meta.lastId++; },
  save(){
    localStorage.setItem("judo_mvp_state", JSON.stringify(this.state));
  },
  load(){
    const raw = localStorage.getItem("judo_mvp_state");
    if(raw){
      try{ this.state = JSON.parse(raw); }catch(e){ console.warn("Estado corrupto, se reinicia."); }
    }else{
      // Datos de ejemplo mínimos
      const profId = this.nextId();
      const colId = this.nextId();
      const grpId = this.nextId();
      this.state.profesores.push({id: profId, nombre:"Ana López", telefono:"", email:"", zona:"Centro", tarifa_hora:20, iban:"", disponibilidad:"Lu-Mi 16:00-19:00", titulos:"Cinturón negro, Monitor", certificados:"Seguro (2026-12-31)"});
      this.state.colegios.push({id: colId, nombre:"CEIP Río Verde", direccion:"C/ Río 1", contacto:"direccion@rioverde.es", festivos:""});
      this.state.grupos.push({id: grpId, colegio_id: colId, nombre:"Infantil A", nivel:"6-8 años", aforo:15, horario:"Miércoles 17:00-18:00", profesor_id: profId});
      this.state.meta.lastId = Math.max(profId, colId, grpId) + 1;
      this.save();
    }
  },
  router(){
    const tab = (location.hash.replace("#","") || "inicio");
    this.renderTabs(tab);
    const view = document.getElementById("view");
    switch(tab){
      case "inicio": this.viewInicio(view); break;
      case "profesores": this.viewProfesores(view); break;
      case "colegios": this.viewColegios(view); break;
      case "grupos": this.viewGrupos(view); break;
      case "calendario": this.viewCalendario(view); break;
      case "sesiones": this.viewSesiones(view); break;
      case "incidencias": this.viewIncidencias(view); break;
      case "mensajes": this.viewMensajes(view); break;
      case "pagos": this.viewPagos(view); break;
      case "datos": this.viewDatos(view); break;
      default: view.innerHTML = "<p>No encontrado.</p>";
    }
  },
  renderTabs(active){
    const nav = document.getElementById("tabs");
    nav.innerHTML = "";
    for(const [id,label] of this.tabs){
      const b = document.createElement("button");
      b.textContent = label;
      if(active===id) b.classList.add("active");
      b.onclick = ()=>{ location.hash = id; };
      nav.appendChild(b);
    }
  },
  // Utils
  fmtDateTime(dstr){
    const d = new Date(dstr);
    if(isNaN(d)) return dstr || "";
    return d.toLocaleString();
  },
  find(arr, id){ return arr.find(x=>x.id==id); },
  selectOptions(arr, getLabel){
    return arr.map(x=>`<option value="${x.id}">${getLabel?getLabel(x):x.nombre}</option>`).join("");
  },
  removeById(arr, id){
    const idx = arr.findIndex(x=>x.id==id);
    if(idx>=0) arr.splice(idx,1);
  },
  // ==== Views ====
  viewInicio(node){
    const totSes = this.state.sesiones.length;
    const impartidas = this.state.sesiones.filter(s=>s.estado==="impartida").length;
    const sustit = this.state.sesiones.filter(s=>s.sustituto_id).length;
    const alertas = this.alertasCaducidad();
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Resumen</h3>
        <div class="row">
          <div class="card" style="flex:1"><div class="inline"><strong>${this.state.profesores.length}</strong> profesores</div></div>
          <div class="card" style="flex:1"><div class="inline"><strong>${this.state.colegios.length}</strong> colegios</div></div>
          <div class="card" style="flex:1"><div class="inline"><strong>${this.state.grupos.length}</strong> grupos</div></div>
        </div>
        <div class="row">
          <div class="card" style="flex:1"><div class="inline"><strong>${totSes}</strong> sesiones planificadas</div></div>
          <div class="card" style="flex:1"><div class="inline"><strong>${impartidas}</strong> impartidas</div></div>
          <div class="card" style="flex:1"><div class="inline"><strong>${sustit}</strong> sustituciones</div></div>
        </div>
      </div>
      <div class="card">
        <h3>Acciones rápidas</h3>
        <div class="actions">
          <a class="btn primary" href="#sesiones">Planificar sesión</a>
          <a class="btn" href="#calendario">Ver calendario</a>
          <a class="btn" href="#mensajes">Enviar aviso</a>
          <a class="btn warn" href="#datos">Exportar datos</a>
        </div>
      </div>
      <div class="card">
        <h3>Alertas</h3>
        ${alertas.length? alertas.map(a=>`<div class="inline"><span class="pill ${a.level}">${a.level.toUpperCase()}</span> ${a.text}</div>`).join("<br/>") : `<div class="muted">Sin alertas.</div>`}
      </div>
    </div>`;
  },
  // Profesores
  viewProfesores(node){
    const list = this.state.profesores;
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Nuevo profesor</h3>
        <div class="row">
          <div><label>Nombre</label><input id="p_nombre"></div>
          <div><label>Zona</label><input id="p_zona"></div>
        </div>
        <div class="row">
          <div><label>Email</label><input id="p_email" type="email"></div>
          <div><label>Teléfono</label><input id="p_tel"></div>
        </div>
        <div class="row">
          <div><label>Tarifa €/h</label><input id="p_tarifa" type="number" value="20"></div>
          <div><label>IBAN</label><input id="p_iban"></div>
        </div>
        <label>Disponibilidad</label><input id="p_disp" placeholder="Ej: Lu-Mi 16:00-19:00">
        <label>Títulos</label><input id="p_tit">
        <label>Certificados (con caducidad)</label><input id="p_cert" placeholder="Seguro (2026-12-31)">
        <div class="actions"><button class="btn success" id="p_add">Añadir</button></div>
      </div>
      <div class="card" style="grid-column: 1/-1;">
        <h3>Profesores</h3>
        ${list.length? `
        <table>
          <thead><tr><th>Nombre</th><th>Zona</th><th>Contacto</th><th>Tarifa</th><th>Disponibilidad</th><th></th></tr></thead>
          <tbody>${list.map(p=>`
            <tr>
              <td><strong>${p.nombre}</strong><br><span class="muted">${p.titulos||""}</span></td>
              <td>${p.zona||""}</td>
              <td>${p.email||""}<br>${p.telefono||""}</td>
              <td>${p.tarifa_hora??""} €/h</td>
              <td>${p.disponibilidad||""}</td>
              <td class="right">
                <button class="btn" onclick="App.editProfesor(${p.id})">Editar</button>
                <button class="btn danger" onclick="App.delProfesor(${p.id})">Eliminar</button>
              </td>
            </tr>`).join("")}</tbody>
        </table>` : `<div class="no-data">Sin profesores.</div>`}
      </div>
    </div>`;
    document.getElementById("p_add").onclick = ()=>{
      const p = {
        id: this.nextId(),
        nombre: document.getElementById("p_nombre").value.trim(),
        zona: document.getElementById("p_zona").value.trim(),
        email: document.getElementById("p_email").value.trim(),
        telefono: document.getElementById("p_tel").value.trim(),
        tarifa_hora: Number(document.getElementById("p_tarifa").value||0),
        iban: document.getElementById("p_iban").value.trim(),
        disponibilidad: document.getElementById("p_disp").value.trim(),
        titulos: document.getElementById("p_tit").value.trim(),
        certificados: document.getElementById("p_cert").value.trim()
      };
      if(!p.nombre){ alert("Nombre obligatorio"); return; }
      this.state.profesores.push(p); this.save(); this.router();
    };
  },
  editProfesor(id){
    const p = this.find(this.state.profesores, id);
    if(!p) return;
    const nombre = prompt("Nombre", p.nombre); if(nombre===null) return;
    p.nombre = nombre;
    p.zona = prompt("Zona", p.zona||"")??p.zona;
    p.email = prompt("Email", p.email||"")??p.email;
    p.telefono = prompt("Teléfono", p.telefono||"")??p.telefono;
    p.tarifa_hora = Number(prompt("Tarifa €/h", p.tarifa_hora??0)??p.tarifa_hora);
    p.iban = prompt("IBAN", p.iban||"")??p.iban;
    p.disponibilidad = prompt("Disponibilidad", p.disponibilidad||"")??p.disponibilidad;
    p.titulos = prompt("Títulos", p.titulos||"")??p.titulos;
    p.certificados = prompt("Certificados", p.certificados||"")??p.certificados;
    this.save(); this.router();
  },
  delProfesor(id){
    if(!confirm("Eliminar profesor?")) return;
    this.removeById(this.state.profesores, id);
    // Desasignar de grupos
    this.state.grupos.forEach(g=>{ if(g.profesor_id==id) g.profesor_id = null; });
    this.save(); this.router();
  },
  // Colegios
  viewColegios(node){
    const list = this.state.colegios;
    node.innerHTML = `
      <div class="grid">
        <div class="card">
          <h3>Nuevo colegio</h3>
          <label>Nombre</label><input id="c_nombre">
          <label>Dirección</label><input id="c_dir">
          <label>Contacto</label><input id="c_contacto">
          <label>Festivos (texto)</label><input id="c_fest">
          <div class="actions"><button class="btn success" id="c_add">Añadir</button></div>
        </div>
        <div class="card" style="grid-column:1/-1;">
          <h3>Colegios</h3>
          ${list.length? `
          <table><thead><tr><th>Nombre</th><th>Dirección</th><th>Contacto</th><th>Festivos</th><th></th></tr></thead>
          <tbody>${list.map(c=>`
            <tr>
              <td><strong>${c.nombre}</strong></td>
              <td>${c.direccion||""}</td>
              <td>${c.contacto||""}</td>
              <td>${c.festivos||""}</td>
              <td class="right">
                <button class="btn" onclick="App.editColegio(${c.id})">Editar</button>
                <button class="btn danger" onclick="App.delColegio(${c.id})">Eliminar</button>
              </td>
            </tr>`).join("")}</tbody></table>` : `<div class="no-data">Sin colegios.</div>`}
        </div>
      </div>`;
    document.getElementById("c_add").onclick = ()=>{
      const c = { id:this.nextId(), nombre: c_nombre.value.trim(), direccion:c_dir.value.trim(), contacto:c_contacto.value.trim(), festivos:c_fest.value.trim() };
      if(!c.nombre){ alert("Nombre obligatorio"); return; }
      this.state.colegios.push(c); this.save(); this.router();
    };
  },
  editColegio(id){
    const c = this.find(this.state.colegios, id); if(!c) return;
    c.nombre = prompt("Nombre", c.nombre)||c.nombre;
    c.direccion = prompt("Dirección", c.direccion||"")??c.direccion;
    c.contacto = prompt("Contacto", c.contacto||"")??c.contacto;
    c.festivos = prompt("Festivos", c.festivos||"")??c.festivos;
    this.save(); this.router();
  },
  delColegio(id){
    if(!confirm("Eliminar colegio?")) return;
    this.removeById(this.state.colegios, id);
    // Desasignar grupos del colegio
    this.state.grupos = this.state.grupos.filter(g=>g.colegio_id!=id);
    this.save(); this.router();
  },
  // Grupos
  viewGrupos(node){
    const list = this.state.grupos;
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Nuevo grupo</h3>
        <label>Colegio</label>
        <select id="g_col">${this.selectOptions(this.state.colegios)}</select>
        <label>Nombre</label><input id="g_nom">
        <div class="row">
          <div><label>Nivel/Edad</label><input id="g_nivel" placeholder="6-8 años"></div>
          <div><label>Aforo</label><input id="g_aforo" type="number" value="15"></div>
        </div>
        <label>Horario</label><input id="g_hor" placeholder="Mi 17:00-18:00">
        <label>Profesor asignado</label>
        <select id="g_prof"><option value="">(Sin asignar)</option>${this.selectOptions(this.state.profesores)}</select>
        <div class="actions"><button class="btn success" id="g_add">Añadir</button></div>
      </div>
      <div class="card" style="grid-column:1/-1;">
        <h3>Grupos</h3>
        ${list.length?`
        <table><thead><tr><th>Grupo</th><th>Colegio</th><th>Horario</th><th>Profesor</th><th>Aforo</th><th></th></tr></thead>
        <tbody>${list.map(g=>{
          const col = this.find(this.state.colegios, g.colegio_id) || {};
          const prof = this.find(this.state.profesores, g.profesor_id) || {};
          return `<tr>
            <td><strong>${g.nombre}</strong><br><span class="muted">${g.nivel||""}</span></td>
            <td>${col.nombre||""}</td>
            <td>${g.horario||""}</td>
            <td>${prof.nombre||"<span class='muted'>Sin asignar</span>"}</td>
            <td>${g.aforo??""}</td>
            <td class="right">
              <button class="btn" onclick="App.editGrupo(${g.id})">Editar</button>
              <button class="btn" onclick="location.hash='sesiones'; setTimeout(()=>App.quickPlan(${g.id}), 50)">Planificar</button>
              <button class="btn danger" onclick="App.delGrupo(${g.id})">Eliminar</button>
            </td>
          </tr>`}).join("")}</tbody></table>` : `<div class="no-data">Sin grupos.</div>`}
      </div>
    </div>`;
    document.getElementById("g_add").onclick = ()=>{
      const g = {
        id:this.nextId(),
        colegio_id: Number(g_col.value),
        nombre: g_nom.value.trim(),
        nivel: g_nivel.value.trim(),
        aforo: Number(g_aforo.value||0),
        horario: g_hor.value.trim(),
        profesor_id: g_prof.value? Number(g_prof.value): null
      };
      if(!g.nombre){ alert("Nombre obligatorio"); return; }
      this.state.grupos.push(g); this.save(); this.router();
    };
  },
  editGrupo(id){
    const g = this.find(this.state.grupos, id); if(!g) return;
    const nombre = prompt("Nombre", g.nombre); if(nombre===null) return;
    g.nombre = nombre;
    g.nivel = prompt("Nivel/Edad", g.nivel||"")??g.nivel;
    g.aforo = Number(prompt("Aforo", g.aforo??0)??g.aforo);
    g.horario = prompt("Horario", g.horario||"")??g.horario;
    const profId = prompt("ID profesor asignado (vacío para ninguno)", g.profesor_id||"");
    g.profesor_id = profId? Number(profId) : null;
    this.save(); this.router();
  },
  delGrupo(id){
    if(!confirm("Eliminar grupo?")) return;
    this.removeById(this.state.grupos, id);
    this.state.sesiones = this.state.sesiones.filter(s=>s.grupo_id!=id);
    this.save(); this.router();
  },
  // Calendario simple
  viewCalendario(node){
    const hoy = new Date();
    const y = hoy.getFullYear(), m = hoy.getMonth();
    const first = new Date(y,m,1);
    const last = new Date(y,m+1,0);
    const days = [];
    for(let d=1; d<=last.getDate(); d++) days.push(new Date(y,m,d));
    const sesionesMes = this.state.sesiones.filter(s=>{
      const t = new Date(s.fecha_inicio);
      return t.getMonth()==m && t.getFullYear()==y;
    });
    node.innerHTML = `
    <div class="card">
      <h3>Calendario ${hoy.toLocaleString(undefined,{month:"long", year:"numeric"})}</h3>
      <div style="display:grid; grid-template-columns: repeat(7,1fr); gap:8px;">
        ${["L","M","X","J","V","S","D"].map(d=>`<div class="muted" style="text-align:center;">${d}</div>`).join("")}
        ${(()=>{
          const pad = (first.getDay()+6)%7; // lunes=0
          let html = "";
          for(let i=0;i<pad;i++) html += `<div></div>`;
          for(const d of days){
            const daySes = sesionesMes.filter(s=> new Date(s.fecha_inicio).getDate()==d.getDate());
            html += `<div class="card" style="padding:8px;">
              <div class="inline" style="justify-content:space-between;">
                <strong>${d.getDate()}</strong>
                ${daySes.length? `<span class="tag">${daySes.length} sesión${daySes.length>1?"es":""}</span>`:""}
              </div>
              ${daySes.slice(0,3).map(s=>{
                const g = this.find(this.state.grupos, s.grupo_id)||{};
                return `<div class="muted">${this.timeRange(s)} – ${g.nombre||""}</div>`;
              }).join("")}
            </div>`;
          }
          return html;
        })()}
      </div>
    </div>`;
  },
  timeRange(s){
    const a = new Date(s.fecha_inicio), b = new Date(s.fecha_fin);
    const fmt = (d)=> d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    return `${fmt(a)}-${fmt(b)}`;
  },
  // Sesiones (planificación, asistencia, sustituciones)
  viewSesiones(node){
    const list = this.state.sesiones.slice().sort((a,b)=> new Date(a.fecha_inicio)-new Date(b.fecha_inicio));
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Nueva sesión</h3>
        <label>Grupo</label>
        <select id="s_grp">${this.selectOptions(this.state.grupos, g=>`${g.nombre} – ${ (this.find(this.state.colegios,g.colegio_id)||{}).nombre||"" }`)}</select>
        <div class="row">
          <div><label>Inicio</label><input id="s_ini" type="datetime-local"></div>
          <div><label>Fin</label><input id="s_fin" type="datetime-local"></div>
        </div>
        <label>Profesor</label>
        <select id="s_prof"><option value="">(Del grupo)</option>${this.selectOptions(this.state.profesores)}</select>
        <div class="actions">
          <button class="btn success" id="s_add">Crear</button>
          <button class="btn" id="s_gen_semana">Generar semana (grupo)</button>
        </div>
      </div>
      <div class="card" style="grid-column:1/-1;">
        <h3>Sesiones</h3>
        ${list.length?`
        <table>
          <thead><tr><th>Fecha</th><th>Grupo</th><th>Profesor</th><th>Estado</th><th>Asistencia</th><th></th></tr></thead>
          <tbody>${list.map(s=>{
            const g = this.find(this.state.grupos, s.grupo_id)||{};
            const p = this.find(this.state.profesores, s.sustituto_id||s.profesor_id||g.profesor_id)||{};
            const estado = s.estado||"planificada";
            return `<tr>
              <td>${this.fmtDateTime(s.fecha_inicio)}<br><span class="muted">${this.timeRange(s)}</span></td>
              <td>${g.nombre||""}</td>
              <td>${p.nombre||"<span class='muted'>Sin asignar</span>"}
                  ${s.sustituto_id? " <span class='pill warn'>Sustitución</span>": ""}
              </td>
              <td>${estado=="impartida"?"<span class='pill ok'>Impartida</span>": estado=="cancelada"?"<span class='pill danger'>Cancelada</span>":"<span class='pill warn'>Planificada</span>"}</td>
              <td>
                <button class="btn" onclick="App.pasarLista(${s.id})">Pasar lista</button>
              </td>
              <td class="right">
                <button class="btn" onclick="App.sustitucion(${s.id})">Necesito sustitución</button>
                <button class="btn" onclick="App.marcarEstado(${s.id})">Cambiar estado</button>
                <button class="btn" onclick="App.editSesion(${s.id})">Editar</button>
                <button class="btn danger" onclick="App.delSesion(${s.id})">Eliminar</button>
              </td>
            </tr>`}).join("")}</tbody>
        </table>` : `<div class="no-data">Sin sesiones.</div>`}
      </div>
    </div>`;
    document.getElementById("s_add").onclick = ()=>{
      const s = {
        id:this.nextId(),
        grupo_id: Number(s_grp.value),
        fecha_inicio: s_ini.value,
        fecha_fin: s_fin.value,
        profesor_id: s_prof.value? Number(s_prof.value) : null,
        sustituto_id: null,
        estado: "planificada",
        asistencia: [] // {alumno, estado, notas}
      };
      if(!s.grupo_id || !s.fecha_inicio || !s.fecha_fin){ alert("Rellene grupo, inicio y fin."); return; }
      this.state.sesiones.push(s); this.save(); this.router();
    };
    document.getElementById("s_gen_semana").onclick = ()=>{
      const gid = Number(s_grp.value);
      const base = new Date();
      for(let i=0;i<5;i++){
        const start = new Date(base.getFullYear(), base.getMonth(), base.getDate()+i, 17, 0, 0);
        const end = new Date(start.getTime()+60*60*1000);
        this.state.sesiones.push({ id:this.nextId(), grupo_id: gid, fecha_inicio:start.toISOString().slice(0,16), fecha_fin:end.toISOString().slice(0,16), profesor_id:null, sustituto_id:null, estado:"planificada", asistencia:[] });
      }
      this.save(); this.router();
    };
  },
  quickPlan(grupoId){
    location.hash = "sesiones";
    const sel = document.getElementById("s_grp");
    if(sel){ sel.value = grupoId; }
  },
  editSesion(id){
    const s = this.find(this.state.sesiones, id); if(!s) return;
    const ini = prompt("Inicio (YYYY-MM-DDTHH:mm)", s.fecha_inicio)||s.fecha_inicio;
    const fin = prompt("Fin (YYYY-MM-DDTHH:mm)", s.fecha_fin)||s.fecha_fin;
    s.fecha_inicio = ini; s.fecha_fin = fin;
    const pid = prompt("ID profesor (vacío=del grupo)", s.profesor_id||"");
    s.profesor_id = pid? Number(pid): null;
    this.save(); this.router();
  },
  delSesion(id){
    if(!confirm("Eliminar sesión?")) return;
    this.removeById(this.state.sesiones, id); this.save(); this.router();
  },
  marcarEstado(id){
    const s = this.find(this.state.sesiones, id); if(!s) return;
    const est = prompt("Estado: planificada / impartida / cancelada", s.estado||"planificada");
    if(!est) return;
    s.estado = est;
    this.save(); this.router();
  },
  pasarLista(id){
    const s = this.find(this.state.sesiones, id); if(!s) return;
    const g = this.find(this.state.grupos, s.grupo_id)||{};
    const alumnos = (g.alumnos||"").split(",").map(x=>x.trim()).filter(Boolean);
    const actuales = s.asistencia||[];
    const nuevo = prompt(`Alumnos separados por coma y estado P/A/T.\nEj: Juan:P, Ana:A\n\nAlumnos del grupo (${alumnos.length}): ${alumnos.join(", ")}\n\nAsistencia actual (se sobrescribe):`, actuales.map(a=>`${a.alumno}:${a.estado}`).join(", "));
    if(nuevo===null) return;
    const arr = nuevo.split(",").map(x=>x.trim()).filter(Boolean);
    const res = [];
    for(const item of arr){
      const [alumno, estadoRaw] = item.split(":").map(s=>s.trim());
      const estado = (estadoRaw||"P").toUpperCase().slice(0,1);
      res.push({ alumno, estado }); // P presente, A ausente, T tarde
    }
    s.asistencia = res;
    s.estado = "impartida";
    this.save(); this.router();
  },
  sustitucion(id){
    const s = this.find(this.state.sesiones, id); if(!s) return;
    const candidatos = this.state.profesores.filter(p=>true); // MVP: todos
    const elegido = prompt("ID de profesor que acepta la sustitución.\nCandidatos:\n"+candidatos.map(p=>`${p.id} – ${p.nombre}`).join("\n"));
    if(!elegido) return;
    s.sustituto_id = Number(elegido);
    this.save(); this.router();
  },
  // Incidencias
  viewIncidencias(node){
    const list = this.state.incidencias.slice().reverse();
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Nueva incidencia</h3>
        <label>Tipo</label><select id="i_tipo">
          <option>Material</option><option>Conducta</option><option>Lesión</option><option>Instalación</option>
        </select>
        <label>Descripción</label><textarea id="i_desc" placeholder="Detalle..."></textarea>
        <div class="row">
          <div><label>Prioridad</label><select id="i_prio"><option>Baja</option><option>Media</option><option>Alta</option></select></div>
          <div><label>Estado</label><select id="i_est"><option>Nuevo</option><option>En curso</option><option>Resuelto</option></select></div>
        </div>
        <div class="actions"><button class="btn success" id="i_add">Registrar</button></div>
      </div>
      <div class="card" style="grid-column:1/-1;">
        <h3>Incidencias</h3>
        ${list.length?`
        <table><thead><tr><th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Prioridad</th><th>Estado</th><th></th></tr></thead>
        <tbody>${list.map(i=>`
          <tr>
            <td>${this.fmtDateTime(i.fecha)}</td>
            <td>${i.tipo}</td>
            <td>${i.descripcion}</td>
            <td>${i.prioridad}</td>
            <td>${i.estado}</td>
            <td class="right">
              <button class="btn" onclick="App.cambiarEstadoInc(${i.id})">Cambiar</button>
              <button class="btn danger" onclick="App.delIncidencia(${i.id})">Eliminar</button>
            </td>
          </tr>`).join("")}</tbody></table>` : `<div class="no-data">Sin incidencias.</div>`}
      </div>
    </div>`;
    document.getElementById("i_add").onclick = ()=>{
      const i = {
        id:this.nextId(),
        fecha: new Date().toISOString(),
        tipo: i_tipo.value,
        descripcion: i_desc.value.trim(),
        prioridad: i_prio.value,
        estado: i_est.value
      };
      if(!i.descripcion){ alert("Añada una descripción."); return; }
      this.state.incidencias.push(i); this.save(); this.router();
    };
  },
  cambiarEstadoInc(id){
    const i = this.find(this.state.incidencias, id); if(!i) return;
    i.estado = prompt("Estado (Nuevo / En curso / Resuelto)", i.estado||"Nuevo")||i.estado;
    this.save(); this.router();
  },
  delIncidencia(id){
    if(!confirm("Eliminar incidencia?")) return;
    this.removeById(this.state.incidencias, id); this.save(); this.router();
  },
  // Mensajes (historial simple)
  viewMensajes(node){
    const list = this.state.mensajes.slice().reverse();
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Nuevo mensaje</h3>
        <label>Plantilla</label>
        <select id="m_tpl">
          <option value="cambio">Cambio de horario</option>
          <option value="recordatorio">Recordatorio equipación</option>
          <option value="evento">Evento/Competición</option>
          <option value="libre">Mensaje libre</option>
        </select>
        <label>Destinatarios</label>
        <select id="m_dest">
          <option value="profesores">Profesores</option>
          <option value="grupo">Grupo específico</option>
          <option value="todos">Todos</option>
        </select>
        <label>Grupo (si aplica)</label>
        <select id="m_grupo"><option value="">(N/A)</option>${this.selectOptions(this.state.grupos)}</select>
        <label>Contenido</label>
        <textarea id="m_body" placeholder="Texto del mensaje"></textarea>
        <div class="actions"><button class="btn success" id="m_send">Registrar envío</button></div>
      </div>
      <div class="card" style="grid-column:1/-1;">
        <h3>Historial</h3>
        ${list.length?`
        <table><thead><tr><th>Fecha</th><th>Destinatarios</th><th>Asunto</th><th>Contenido</th><th></th></tr></thead>
        <tbody>${list.map(m=>`
          <tr>
            <td>${this.fmtDateTime(m.fecha)}</td>
            <td>${m.destinatarios}</td>
            <td>${m.asunto}</td>
            <td>${m.contenido}</td>
            <td class="right"><button class="btn danger" onclick="App.delMensaje(${m.id})">Eliminar</button></td>
          </tr>`).join("")}</tbody></table>` : `<div class="no-data">Sin mensajes registrados.</div>`}
      </div>
    </div>`;
    document.getElementById("m_send").onclick = ()=>{
      const asuntoMap = { cambio:"Cambio de horario", recordatorio:"Recordatorio equipación", evento:"Evento/Competición", libre:"Mensaje" };
      const m = {
        id:this.nextId(),
        fecha:new Date().toISOString(),
        asunto: asuntoMap[m_tpl.value] || "Mensaje",
        destinatarios: m_dest.value=="grupo" ? `Grupo: ${(this.find(this.state.grupos, Number(m_grupo.value))||{}).nombre||""}` : m_dest.value,
        contenido: m_body.value.trim()
      };
      if(!m.contenido){ alert("Escriba un contenido."); return; }
      this.state.mensajes.push(m); this.save(); this.router();
    };
  },
  delMensaje(id){
    if(!confirm("Eliminar mensaje?")) return;
    this.removeById(this.state.mensajes, id); this.save(); this.router();
  },
  // Pagos (cálculo por horas simple)
  viewPagos(node){
    // Recalcular horas por profesor a partir de sesiones impartidas
    const resumen = {};
    for(const s of this.state.sesiones){
      if(s.estado!=="impartida") continue;
      const profId = s.sustituto_id || s.profesor_id || (this.find(this.state.grupos, s.grupo_id)||{}).profesor_id;
      if(!profId) continue;
      const horas = (new Date(s.fecha_fin)-new Date(s.fecha_inicio))/3600000;
      resumen[profId] = (resumen[profId]||0) + horas;
    }
    node.innerHTML = `
    <div class="card">
      <h3>Cierre (automático desde sesiones impartidas)</h3>
      ${Object.keys(resumen).length?`
      <table><thead><tr><th>Profesor</th><th>Horas</th><th>Tarifa</th><th>Importe</th></tr></thead>
      <tbody>${Object.entries(resumen).map(([pid, horas])=>{
        const p = this.find(this.state.profesores, Number(pid))||{};
        const tarifa = p.tarifa_hora||0;
        const imp = (horas*tarifa).toFixed(2);
        return `<tr>
          <td>${p.nombre||pid}</td>
          <td>${horas.toFixed(2)}</td>
          <td>${tarifa.toFixed?tarifa.toFixed(2):tarifa} €</td>
          <td><strong>${imp} €</strong></td>
        </tr>`}).join("")}</tbody></table>` : `<div class="no-data">Sin sesiones impartidas.</div>`}
      <div class="muted" style="margin-top:8px;">Nota: edite tarifa en ficha de profesor.</div>
    </div>`;
  },
  // Importar / Exportar
  viewDatos(node){
    node.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3>Exportar</h3>
        <p>Descargue una copia de seguridad (.json).</p>
        <div class="actions">
          <button class="btn" onclick="App.exportar()">Exportar JSON</button>
          <button class="btn danger" onclick="App.reset()">Reiniciar datos</button>
        </div>
      </div>
      <div class="card">
        <h3>Importar</h3>
        <p>Restaure desde un archivo exportado.</p>
        <input type="file" id="imp_file" accept="application/json">
        <div class="actions"><button class="btn success" onclick="App.importar()">Importar</button></div>
      </div>
      <div class="card" style="grid-column:1/-1;">
        <details>
          <summary>Cómo usar (resumen)</summary>
          <ul>
            <li>1) Cree profesores y colegios. 2) Cree grupos vinculados al colegio y asigne profesor.</li>
            <li>3) Planifique sesiones y pase lista (marcará como “impartida”).</li>
            <li>4) Use “Necesito sustitución” si un profesor no puede acudir, y asigne al sustituto.</li>
            <li>5) Cierre de horas automático en la pestaña “Horas y Pagos”.</li>
            <li>6) Exportar para copia de seguridad.</li>
          </ul>
        </details>
      </div>
    </div>`;
  },
  exportar(){
    const blob = new Blob([JSON.stringify(this.state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "judo_mvp_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
  },
  importar(){
    const f = document.getElementById("imp_file").files[0];
    if(!f){ alert("Seleccione un archivo."); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if(!obj || !obj.meta) throw new Error("Archivo no válido");
        this.state = obj;
        this.save();
        alert("Importado correctamente.");
        this.router();
      }catch(e){
        alert("No se pudo importar: "+e.message);
      }
    };
    reader.readAsText(f);
  },
  reset(){
    if(!confirm("Esto borrará los datos. ¿Continuar?")) return;
    localStorage.removeItem("judo_mvp_state");
    location.reload();
  },
  alertasCaducidad(){
    const res = [];
    const now = new Date();
    for(const p of this.state.profesores){
      const m = (p.certificados||"").match(/\((\d{4}-\d{2}-\d{2})\)/);
      if(m){
        const cad = new Date(m[1]);
        const diff = Math.ceil((cad-now)/86400000);
        if(diff<=30 && diff>0) res.push({level:"warn", text:`${p.nombre}: certificado caduca en ${diff} días (${m[1]})`});
        if(diff<=0) res.push({level:"danger", text:`${p.nombre}: certificado CADUCADO (${m[1]})`});
      }
    }
    return res;
  }
};

window.App = App;
App.init();
</script>
</body>
</html>
